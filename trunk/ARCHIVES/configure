#!/bin/sh
###########################################################################
##  configure   Linbox library 
## Copyright (C) 1999, The Linbox Group.
###########################################################################

umask 002

ORIG="config"
TARG="src"

usage() {
  echo "usage: configure [ [ -i | --prefix ] installdir ] "
  echo "                 [ -h | -help | --help] "
  echo "                 [[ --include | --link | -- soft ] directory ]"
  echo "                 [ --lib     library_name ]"
  echo "                 [[ --flag | --ccflag | --ldflag] flag ]"
  echo "                 [ --makef   file ]"
  echo "  where :"
  echo "     -i           : location of installation directory"
  echo "                    (default : \`pwd\`)"
  echo "     -h           : Produces this message"
  echo "  remaining parameters affect linbox_makefile :"
  echo "     --include    : adds -I'directory' to CXXFLAGS"
  echo "     --link       : adds -L'directory' to LDFLAGS"
  echo "     --soft       : adds -I'directory' to CXXFLAGS and"
  echo "                    adds -L'directory' to LDFLAGS"
  echo "     --lib        : adds -l'library_name' to LDFLAGS"
  echo "     --flag       : adds flag to CXXFLAGS"
  echo "     --ccflag     : adds flag to CXXFLAGS"
  echo "     --ldflag     : adds flag to LDFLAGS"
  echo "     --makef      : adds 'include file' to the beginning of linbox_makefile"
  echo ""
  echo "  remark: each path needs to be absolute."
  exit 127
}


using() {
  echo "----- Linbox library setup -----"
  echo "--- Install directory  : $lininstall"
  if [ ! -z "$lincxxflags" -o ! -z "$lincxxflags" -o "$linmakef" = "1" ]; then
  	echo "--- Added to makefile  :"
  fi
  if [ "$linmakef" = "1" ]; then
	cat tmpmakef.1
  fi
  if [ ! -z "$lincxxflags" ]; then
  	echo "CXXFLAGS += $lincxxflags"
  fi
  if [ ! -z "$linldflags" ]; then
  	echo "LDFLAGS  += $linldflags"
  fi
}

gen_msg() {
echo "# ----------------------------------------------------------------"
echo "# (C) The Linbox Group 2000"
echo "# ----------------------------------------------------------------"
echo "# ****************************************************************"
echo "# WARNING! This file has been automatically generated by configure"
echo "# "`date`
echo "# ****************************************************************"
echo ""
}

#defaults
lininstall=`pwd`
lincxxflags=""
linldflags=""
linmakef=0
\rm -f tmpmakef.1
touch tmpmakef.1

#
# Parsing arguments
#
getpar=no # next argument is a parameter

for i in $*
do
  if [ $getpar = no ]; then
    if [ "$i" = "-i" -o "$i" = "--prefix" ]; then
      getpar=getdir
    elif [ "$i" = "-h" -o "$i" = "--h" -o "$i" = "-help" -o "$i" = "--help" ]; then
      usage >&2
    elif [ "$i" = "--include" ]; then
      getpar=getinc
    elif [ "$i" = "--link" ]; then
      getpar=getlin
    elif [ "$i" = "--soft" ]; then
      getpar=getsof
    elif [ "$i" = "--lib" ]; then
      getpar=getlib
    elif [ "$i" = "--flag" ]; then
      getpar=getfla
    elif [ "$i" = "--ccflag" ]; then
      getpar=getcfl
    elif [ "$i" = "--ldflag" ]; then
      getpar=getlfl
    elif [ "$i" = "--makef" ]; then
      getpar=getmak
    else
      echo "*** unrecognized parameter $i" >&2
      usage >&2
    fi
  else
    case $getpar in
      getdir)     lininstall="$i";;
      getinc)     lincxxflags="$lincxxflags -I$i";;
      getlin)     linldflags="$linldflags -L$i";;
      getsof)     lincxxflags="$lincxxflags -I$i"; linldflags="$linldflags -L$i";;
      getlib)     linldflags="$linldflags -l$i";;
      getfla)     lincxxflags="$lincxxflags $i";;
      getcfl)     lincxxflags="$lincxxflags $i";;
      getlfl)     linldflags="$linldflags $i";;
      getmak)	  linmakef=1; echo "include $i" >> tmpmakef.1
   esac
   getpar=no
  fi
done

#
# args Verification
#
linincdir=$lininstall/include
linbindir=$lininstall/bin
linlibdir=$lininstall/lib

using
echo ""
echo "Does this setup suit you ? (y/n) \c"
read answer
if [ "$answer" = "n" -o "$answer" = "no" -o "$answer" = "N" -o "$answer" = "NO" ]; then
    exit 127
fi
    
#######
# Creating directories in prefix
#######
if [ ! -d "$lininstall" ]; then
  echo "The directory $lininstall seems not to exists." >&2
  echo "Trying to create it ..." >&2
  mkdir $lininstall
fi

if [ ! -d "$linincdir" ]; then
  mkdir $linincdir
fi
if [ ! -d "$linbindir" ]; then
  mkdir $linbindir
fi
if [ ! -d "$linlibdir" ]; then
  mkdir $linlibdir
fi

#######
# Generating status file
#######
gen_msg > $ORIG/configure.status

cat >> $ORIG/configure.status <<EOF
#----------------------------------------------------
# Linbox library configuration status
# executed command
$0 $*
#
EOF
using >> $ORIG/configure.status


#######
# Generating config files
#######
\rm -f sedfile tmpfile.1 tmpfile
touch tmpfile.1
touch sedfile

echo "linincdir="\""$linincdir"\" >> tmpfile.1
echo "lininstall="\""$lininstall"\" >> tmpfile.1

sed 's/\//\\\//g' tmpfile.1 > tmpfile

echo "echo s/@LININCDIR@/\$linincdir/g >> sedfile" >> tmpfile
echo "echo s/@LINROOTDIR@/\$lininstall/g >> sedfile" >> tmpfile

chmod +x tmpfile
./tmpfile

\rm -f Makefile.rules Make.listing

##### Makefile.rules
gen_msg > $TARG/Makefile.rules
sed -f sedfile $ORIG/Makefile.rules.in >> $TARG/Makefile.rules

##### Make.listing
gen_msg > $TARG/Make.listing
sed -f sedfile $ORIG/Make.listing.in >> $TARG/Make.listing
chmod a+x $TARG/Make.listing

##### linbox_makefile
gen_msg > $linincdir/linbox_makefile
echo "ifndef __LINBOX_MAKEFILE__" >> $linincdir/linbox_makefile
echo "__LINBOX_MAKEFILE__=$linincdir/linbox_makefile" >> $linincdir/linbox_makefile
echo "" >> $linincdir/linbox_makefile
echo "## Other makefiles" >> $linincdir/linbox_makefile
cat tmpmakef.1 >> $linincdir/linbox_makefile
\rm -f tmpmakef.1
echo "" >> $linincdir/linbox_makefile
sed -f sedfile $ORIG/linbox_makefile.in >> $linincdir/linbox_makefile
echo "CXXFLAGS+=$lincxxflags" >> $linincdir/linbox_makefile
echo "LDFLAGS+=$linldflags" >> $linincdir/linbox_makefile
echo "" >> $linincdir/linbox_makefile
echo "endif" >> $linincdir/linbox_makefile

##### linbox_setup.csh
gen_msg > $linbindir/linbox_setup.csh
sed -f sedfile $ORIG/linbox_setup.csh.in >> $linbindir/linbox_setup.csh

\rm -f sedfile tmpfile.1 tmpfile

echo ""
echo "Configuration completed."
echo "Please"
echo "source $linbindir/linbox_setup.csh"
echo "and use 'gmake' to compile the library"

##################################################################
## Copyright (C) 1999, The Linbox Group.
##################################################################
